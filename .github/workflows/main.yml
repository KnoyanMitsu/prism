name: Build Prism (Android, Windows, Linux)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Supaya bisa di-klik run manual

jobs:
  # ---------------------------------------------------
  # 1. BUILD ANDROID (APK)
  # ---------------------------------------------------
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      # Upload hasil APK agar bisa didownload
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Prism-Android
          path: build/app/outputs/flutter-apk/app-release.apk

  # ---------------------------------------------------
  # 2. BUILD WINDOWS (EXE)
  # ---------------------------------------------------
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Windows EXE
        run: flutter build windows --release

      # Windows hasil buildnya berupa folder, jadi kita ZIP dulu
      - name: Compress Build to Zip
        run: Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath prism-windows.zip

      - name: Upload Windows Zip
        uses: actions/upload-artifact@v4
        with:
          name: Prism-Windows
          path: prism-windows.zip

  # ---------------------------------------------------
  # 3. BUILD LINUX (APPIMAGE)
  # ---------------------------------------------------
  build-linux:
    # Gunakan Ubuntu 20.04 agar AppImage bisa jalan di distro lama & baru
    runs-on: ubuntu-20.04 
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Install library wajib Linux (GTK, Clang, CMake, Ninja)
      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Linux Binary
        run: flutter build linux --release

      # --- PROSES PEMBUATAN APPIMAGE ---
      # Kita menggunakan tool 'linuxdeploy' untuk membungkus binary jadi AppImage
      - name: Create AppImage
        run: |
          # 1. Download Tool LinuxDeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          # 2. Siapkan Folder AppDir
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications

          # 3. Copy Binary Flutter ke AppDir
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # 4. Setup Icon & Desktop File (Menggunakan default flutter jika ada)
          # Pastikan file linux/runner/assets/app_icon.png ada di repo kamu!
          if [ -f "linux/runner/assets/app_icon.png" ]; then
            cp linux/runner/assets/app_icon.png AppDir/usr/share/icons/hicolor/256x256/apps/prism.png
          else
            touch AppDir/usr/share/icons/hicolor/256x256/apps/prism.png # Dummy jika tidak ada
          fi

          # Buat file .desktop sederhana
          echo "[Desktop Entry]" > AppDir/usr/share/applications/prism.desktop
          echo "Type=Application" >> AppDir/usr/share/applications/prism.desktop
          echo "Name=Prism" >> AppDir/usr/share/applications/prism.desktop
          echo "Exec=prism" >> AppDir/usr/share/applications/prism.desktop
          echo "Icon=prism" >> AppDir/usr/share/applications/prism.desktop
          echo "Categories=Utility;" >> AppDir/usr/share/applications/prism.desktop

          # 5. Generate AppImage
          # Kita arahkan executable ke nama binary (biasanya nama project di pubspec.yaml, misal 'prism')
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage --desktop-file AppDir/usr/share/applications/prism.desktop --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/prism.png --executable AppDir/usr/bin/prism

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: Prism-Linux-AppImage
          path: Prism-*.AppImage
